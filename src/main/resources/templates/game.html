<!DOCTYPE html>
<html>
<head>
    <title>Car Battle Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .game-area {
            border: 3px solid #333;
            background: #e8f4f8;
            margin: 20px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            transition: background 0.3s;
        }
        button:hover {
            background: #45a049;
        }
        button.stop {
            background: #f44336;
        }
        button.stop:hover {
            background: #da190b;
        }
        .status {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .ai-selector {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        select {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .health-bar {
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }
        .health-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Car Battle AI Game</h1>

    <div class="controls">
        <button onclick="startGame()">üéÆ Start Game</button>
        <button class="stop" onclick="stopGame()">‚èπÔ∏è Stop Game</button>
        <button onclick="openAIEditor()">ü§ñ AI Editor</button>
    </div>

    <div class="ai-selector">
        <div>
            <label>Player 1 (Blue):</label>
            <select id="player1AI">
                <option value="aggressive">Aggressive AI (Speed:5)</option>
                <option value="defensive">Defensive AI (Range:5)</option>
                <option value="simple">Simple AI</option>
                <option value="test">test AI</option>
                <option value="test2">test2 AI</option>
            </select>
        </div>
        <div>
            <label>Player 2 (Red):</label>
            <select id="player2AI">
                <option value="aggressive">Aggressive AI (Speed:5)</option>
                <option value="defensive">Defensive AI (Range:5)</option>
                <option value="simple">Simple AI</option>
                <option value="test">test AI</option>
                <option value="test2">test2 AI</option>
            </select>
        </div>
    </div>

    <div class="status" id="gameStatus">
        <strong>Status:</strong> <span id="statusText">Ready to start</span>
    </div>

    <canvas id="gameArea" class="game-area" width="800" height="600">
        Your browser does not support the canvas element.
    </canvas>

    <div class="debug-info" id="debugInfo">
        Debug information will appear here...
    </div>
</div>

<script>
    let gameRunning = false;
    let animationId = null;
    const canvas = document.getElementById('gameArea');
    const ctx = canvas.getContext('2d');

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    let gameState = {
        player1: { x: 100, y: 100, angle: 0, health: 100, alive: true, name: "Player 1", speed: 0, maxSpeed: 5, canShoot: true },
        player2: { x: 700, y: 500, angle: 180, health: 100, alive: true, name: "Player 2", speed: 0, maxSpeed: 5, canShoot: true },
        bullets: [],
        gameRunning: false
    };

    function updateStatus(message) {
        document.getElementById('statusText').textContent = message;
        console.log('Status:', message);
    }

    function debug(message) {
        const debugDiv = document.getElementById('debugInfo');
        debugDiv.innerHTML = '<strong>Debug:</strong> ' + message;
        console.log('Debug:', message);
    }

    async function startGame() {
        if (gameRunning) {
            updateStatus('Game is already running');
            return;
        }

        try {
            updateStatus('Starting game...');

            const player1AI = document.getElementById('player1AI').value;
            const player2AI = document.getElementById('player2AI').value;

            const startData = {
                player1AI: player1AI,
                player2AI: player2AI
            };

            const response = await fetch('/game/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(startData)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            debug('Start response received');

            gameState = data;
            gameRunning = true;
            updateStatus('Game running - Watch console for detailed logs!');

            gameLoop();

        } catch (error) {
            updateStatus('Error starting game: ' + error.message);
            debug('Error: ' + error.message);
            console.error('Error starting game:', error);
        }
    }

    function stopGame() {
        gameRunning = false;
        if (animationId) {
            cancelAnimationFrame(animationId);
        }

        fetch('/game/stop', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                updateStatus('Game stopped');
                debug('Game stopped by user');
            });
    }

    async function gameLoop() {
        if (!gameRunning) return;

        await updateGame();
        renderGame();

        animationId = requestAnimationFrame(gameLoop);
    }

    async function updateGame() {
        if (!gameRunning) return;

        try {
            const response = await fetch('/game/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const newState = await response.json();
                gameState = newState;

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (gameState.player1 && gameState.player2) {
                    debug(`P1: ${gameState.player1.health}HP, ${gameState.player1.speed?.toFixed(1)} speed | P2: ${gameState.player2.health}HP, ${gameState.player2.speed?.toFixed(1)} speed | Bullets: ${gameState.bullets?.length || 0}`);
                }
            }
        } catch (error) {
            console.error('Error updating game:', error);
        }
    }

    function renderGame() {
        // –û—á–∏—Å—Ç–∫–∞ canvas
        ctx.fillStyle = '#e8f4f8';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
        ctx.strokeStyle = '#d1e7f0';
        ctx.lineWidth = 1;
        for (let x = 0; x <= canvas.width; x += 50) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }
        for (let y = 0; y <= canvas.height; y += 50) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É–ª—å
        if (gameState.bullets) {
            gameState.bullets.forEach(bullet => {
                drawBullet(bullet.x, bullet.y, bullet.angle);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞—à–∏–Ω–æ–∫ –∏–∑ gameState
        if (gameState.player1) {
            const isAlive = gameState.player1.alive;
            const color = isAlive ? 'blue' : 'gray';
            const name = isAlive ? gameState.player1.name : gameState.player1.name + " (DEAD)";
            drawCar(gameState.player1.x, gameState.player1.y, gameState.player1.angle, color, name, isAlive);

            // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –¥–ª—è Player 1
            drawHealthBar(gameState.player1.health, 10, 100, 'blue');
        }

        if (gameState.player2) {
            const isAlive = gameState.player2.alive;
            const color = isAlive ? 'red' : 'gray';
            const name = isAlive ? gameState.player2.name : gameState.player2.name + " (DEAD)";
            drawCar(gameState.player2.x, gameState.player2.y, gameState.player2.angle, color, name, isAlive);

            // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –¥–ª—è Player 2
            drawHealthBar(gameState.player2.health, canvas.width - 210, 100, 'red');
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ HUD
        ctx.fillStyle = 'black';
        ctx.font = 'bold 14px Arial';

        // Player 1 –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        if (gameState.player1) {
            const p1 = gameState.player1;
            ctx.fillText(`Player 1 - ${p1.alive ? 'ALIVE' : 'DEAD'}`, 10, 20);

            if (p1.alive) {
                ctx.font = '12px Arial';
                ctx.fillText(`Health: ${p1.health}`, 10, 40);
                ctx.fillText(`Speed: ${p1.speed?.toFixed(1)}/${p1.maxSpeed?.toFixed(1)}`, 10, 60);
                ctx.fillText(`Shoot: ${p1.canShoot ? 'READY' : 'RELOADING'}`, 10, 80);
            }
        }

        // Player 2 –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        if (gameState.player2) {
            const p2 = gameState.player2;
            ctx.fillText(`Player 2 - ${p2.alive ? 'ALIVE' : 'DEAD'}`, 600, 20);

            if (p2.alive) {
                ctx.font = '12px Arial';
                ctx.fillText(`Health: ${p2.health}`, 600, 40);
                ctx.fillText(`Speed: ${p2.speed?.toFixed(1)}/${p2.maxSpeed?.toFixed(1)}`, 600, 60);
                ctx.fillText(`Shoot: ${p2.canShoot ? 'READY' : 'RELOADING'}`, 600, 80);
            }
        }

        // –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        ctx.fillStyle = 'black';
        ctx.font = '16px Arial';
        ctx.fillText(`Bullets: ${gameState.bullets ? gameState.bullets.length : 0}`, 350, 20);

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        if (gameState.player1 && gameState.player2) {
            if (!gameState.player1.alive && !gameState.player2.alive) {
                ctx.fillStyle = 'purple';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('DRAW!', canvas.width / 2, 50);
                ctx.textAlign = 'left';
            } else if (!gameState.player1.alive) {
                ctx.fillStyle = 'red';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PLAYER 2 WINS!', canvas.width / 2, 50);
                ctx.textAlign = 'left';
            } else if (!gameState.player2.alive) {
                ctx.fillStyle = 'blue';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('PLAYER 1 WINS!', canvas.width / 2, 50);
                ctx.textAlign = 'left';
            }
        }
    }

    function drawHealthBar(health, x, y, color) {
        const width = 200;
        const height = 20;
        const healthPercent = health / 100;

        // –§–æ–Ω
        ctx.fillStyle = '#ddd';
        ctx.fillRect(x, y, width, height);

        // –ó–¥–æ—Ä–æ–≤—å–µ
        ctx.fillStyle = color;
        ctx.fillRect(x, y, width * healthPercent, height);

        // –†–∞–º–∫–∞
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, width, height);

        // –¢–µ–∫—Å—Ç
        ctx.fillStyle = 'black';
        ctx.font = '12px Arial';
        ctx.fillText(`${health}%`, x + width / 2 - 10, y + 14);
    }

    function drawCar(x, y, angle, color, name, isAlive) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle * Math.PI / 180);

        if (isAlive) {
            // –ñ–∏–≤–æ–π —Ç–∞–Ω–∫
            ctx.fillStyle = color;
            ctx.fillRect(-15, -10, 30, 20);

            ctx.fillStyle = '#aaccff';
            ctx.fillRect(-10, -8, 20, 8);

            ctx.fillStyle = '#333';
            ctx.fillRect(10, -2, 15, 4);
        } else {
            // –£–±–∏—Ç—ã–π —Ç–∞–Ω–∫
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.strokeRect(-15, -10, 30, 20);

            ctx.fillStyle = color + '80';
            ctx.fillRect(-15, -10, 30, 20);

            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(-12, -7);
            ctx.lineTo(12, 7);
            ctx.moveTo(12, -7);
            ctx.lineTo(-12, 7);
            ctx.stroke();
        }

        ctx.restore();

        // –ó–æ–Ω–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        if (isAlive) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.arc(x, y, 25, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // –ò–º—è –ø–æ–¥ –º–∞—à–∏–Ω–æ–π
        ctx.fillStyle = isAlive ? 'black' : 'red';
        ctx.font = isAlive ? '12px Arial' : 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(name, x, y + 40);
        ctx.textAlign = 'left';
    }

    function drawBullet(x, y, angle) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle * Math.PI / 180);

        // –ü—É–ª—è
        ctx.fillStyle = '#FFFF00';
        ctx.fillRect(-3, -3, 12, 6);

        // –Ø—Ä–∫–æ–µ —è–¥—Ä–æ
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, -1, 6, 2);

        // –û–≥–Ω–µ–Ω–Ω—ã–π —Ö–≤–æ—Å—Ç
        ctx.fillStyle = '#FF4500';
        ctx.fillRect(-6, -2, 3, 4);

        ctx.restore();

        // –°–≤–µ—á–µ–Ω–∏–µ
        ctx.save();
        ctx.translate(x, y);

        const glow = ctx.createRadialGradient(0, 0, 0, 0, 0, 8);
        glow.addColorStop(0, 'rgba(255, 255, 0, 0.6)');
        glow.addColorStop(1, 'rgba(255, 200, 0, 0)');

        ctx.fillStyle = glow;
        ctx.beginPath();
        ctx.arc(0, 0, 8, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }

    function openAIEditor() {
        window.open('/ai/editor', '_blank');
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', async function() {
        updateStatus('Loading...');
        debug('System initialized');
    });
</script>
</body>
</html>